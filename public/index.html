<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSON Formatter Live</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="manifest" href="manifest.json">
    
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        zinc: {
                            50: '#fafafa',
                            100: '#f4f4f5',
                            200: '#e4e4e7',
                            300: '#d4d4d8',
                            400: '#a1a1aa',
                            500: '#71717a',
                            600: '#52525b',
                            700: '#3f3f46',
                            800: '#27272a',
                            900: '#18181b',
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- CodeMirror 6 bundle -->
    <script type="module" src="js/codemirror-bundle.js"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- Custom styles -->
    <link rel="stylesheet" href="styles/style.css">
    <link rel="stylesheet" href="styles/editor.css">
    
    <!-- Theme initialization script -->
    <script>
        // Check for saved theme preference or use system preference
        const initializeTheme = () => {
            const isDarkMode = localStorage.getItem('isDarkMode') === 'true' || 
                (localStorage.getItem('isDarkMode') === null && 
                window.matchMedia('(prefers-color-scheme: dark)').matches);
            
            if (isDarkMode) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        };
        
        // Initialize theme before page loads to prevent flash
        initializeTheme();
    </script>
</head>

<body class="bg-gray-50 dark:bg-zinc-800 text-gray-900 dark:text-gray-100 transition-colors duration-150 min-h-screen flex flex-col">
    <!-- Header -->
    <header class="text-gray-600 dark:text-gray-300 body-font bg-white dark:bg-zinc-800 transition-colors duration-150">
        <div class="container mx-auto flex p-5 flex-row items-center justify-between">
            <a href="index.html" class="flex title-font font-medium items-center text-gray-900">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-linecap="round"
                    stroke-linejoin="round" stroke-width="2"
                    class="w-10 h-10 text-white p-2 bg-blue-500 rounded-full" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M17.25 6.75L22.5 12l-5.25 5.25m-10.5 0L1.5 12l5.25-5.25m7.5-3l-4.5 16.5" />
                </svg>
                <span class="ml-3 text-xl dark:text-white">json formatter live</span>
            </a>
            
            <div>
                <button id="theme-toggle" 
                    class="inline-flex items-center justify-center rounded-md p-2 text-gray-700 hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-gray-800 focus:outline-none border border-gray-200 dark:border-gray-700"
                    aria-label="Toggle dark mode">
                    <!-- Moon icon for light mode -->
                    <svg id="moon-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 block dark:hidden">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" />
                    </svg>
                    <!-- Sun icon for dark mode -->
                    <svg id="sun-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 hidden dark:block">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" />
                    </svg>
                </button>
            </div>
        </div>
    </header>

    <!-- Main content -->
    <div class="flex min-h-64 flex-col justify-center overflow-hidden bg-gray-50 dark:bg-zinc-800 mt-12 max-w-full transition-colors duration-150">
        <div class="h-full border-2 border-gray-200 dark:border-gray-700 bg-white dark:bg-zinc-900 px-6 pt-10 pb-8 shadow-xl ring-1 ring-gray-900/5 dark:ring-gray-100/5 sm:rounded-lg sm:px-10 mx-6 mb-16 editor-container transition-colors duration-150 relative">
            <div class="absolute top-4 right-6 z-10">
                <button
                    id="copy-button"
                    class="inline-flex items-center px-3 py-2 text-sm font-medium rounded-md text-gray-700 dark:text-gray-300 bg-white dark:bg-zinc-800 border border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-zinc-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 dark:focus:ring-blue-400 dark:focus:ring-offset-zinc-800 transition-colors duration-150"
                    title="Copy to clipboard"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                         stroke="currentColor" class="w-5 h-5 mr-1">
                        <path stroke-linecap="round" stroke-linejoin="round"
                              d="M15.666 3.888A2.25 2.25 0 0 0 13.5 2.25h-3c-1.03 0-1.9.693-2.166 1.638m7.332 0c.055.194.084.4.084.612v0a.75.75 0 0 1-.75.75H9a.75.75 0 0 1-.75-.75v0c0-.212.03-.418.084-.612m7.332 0c.646.049 1.288.11 1.927.184 1.1.128 1.907 1.077 1.907 2.185V19.5a2.25 2.25 0 0 1-2.25 2.25H6.75A2.25 2.25 0 0 1 4.5 19.5V6.257c0-1.108.806-2.057 1.907-2.185a48.208 48.208 0 0 1 1.927-.184"/>
                    </svg>
                    Copy
                </button>
            </div>
            <div id="editor-container" class="w-full h-full"></div>
            <div class="absolute bottom-4 right-6">
                <div class="flex justify-end gap-2">
                    <button
                        id="format-button"
                        class="inline-flex items-center px-3 py-2 text-sm font-medium rounded-md text-gray-700 dark:text-gray-300 bg-white dark:bg-zinc-800 border border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-zinc-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 dark:focus:ring-blue-400 dark:focus:ring-offset-zinc-800 transition-colors duration-150"
                        title="Format JSON (Alt+Shift+F)"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-5 w-5 mr-1">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
                        </svg>
                        Format
                    </button>
                    <button
                        id="minify-button"
                        class="inline-flex items-center px-3 py-2 text-sm font-medium rounded-md text-gray-700 dark:text-gray-300 bg-white dark:bg-zinc-800 border border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-zinc-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 dark:focus:ring-blue-400 dark:focus:ring-offset-zinc-800 transition-colors duration-150"
                        title="Minify JSON (Alt+Shift+M)"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-5 w-5 mr-1">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m.75 12l3 3m0 0l3-3m-3 3v-6m-1.5-9H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
                        </svg>
                        Minify
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-zinc-50 dark:bg-zinc-900 transition-colors duration-150 mt-auto">
        <div class="px-6 py-1 mx-auto overflow-hidden max-w-7xl lg:px-8">
            <nav class="gap-x-5 flex justify-center" aria-label="Footer">
                <div class="pb-6">
                    <a href="about.html" class="text-sm leading-6 text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200">
                        About
                    </a>
                </div>
                <div class="pb-6">
                    <a href="privacy-policy.html" class="text-sm leading-6 text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200">
                        Privacy Policy
                    </a>
                </div>
            </nav>
            <div class="flex justify-center mt-10 space-x-10">
                <a target="_blank" href="#" class="text-gray-400 hover:text-gray-500 dark:text-gray-500 dark:hover:text-gray-400">
                    <span class="sr-only">Facebook</span>
                    <svg fill="currentColor" viewBox="0 0 24 24" class="w-6 h-6" aria-hidden="true">
                        <path
                            fill-rule="evenodd"
                            d="M22 12c0-5.523-4.477-10-10-10S2 6.477 2 12c0 4.991 3.657 9.128 8.438 9.878v-6.987h-2.54V12h2.54V9.797c0-2.506 1.492-3.89 3.777-3.89 1.094 0 2.238.195 2.238.195v2.46h-1.26c-1.243 0-1.63.771-1.63 1.562V12h2.773l-.443 2.89h-2.33v6.988C18.343 21.128 22 16.991 22 12z"
                            clip-rule="evenodd"
                        />
                    </svg>
                </a>
                <a target="_blank" href="#" class="text-gray-400 hover:text-gray-500 dark:text-gray-500 dark:hover:text-gray-400">
                    <span class="sr-only">Twitter</span>
                    <svg fill="currentColor" viewBox="0 0 24 24" class="w-6 h-6" aria-hidden="true">
                        <path d="M8.29 20.251c7.547 0 11.675-6.253 11.675-11.675 0-.178 0-.355-.012-.53A8.348 8.348 0 0022 5.92a8.19 8.19 0 01-2.357.646 4.118 4.118 0 001.804-2.27 8.224 8.224 0 01-2.605.996 4.107 4.107 0 00-6.993 3.743 11.65 11.65 0 01-8.457-4.287 4.106 4.106 0 001.27 5.477A4.072 4.072 0 012.8 9.713v.052a4.105 4.105 0 003.292 4.022 4.095 4.095 0 01-1.853.07 4.108 4.108 0 003.834 2.85A8.233 8.233 0 012 18.407a11.616 11.616 0 006.29 1.84" />
                    </svg>
                </a>
                <a target="_blank" href="https://github.com/alexandrunastase/json-formatter-live" class="text-gray-400 hover:text-gray-500 dark:text-gray-500 dark:hover:text-gray-400">
                    <span class="sr-only">GitHub</span>
                    <svg fill="currentColor" viewBox="0 0 24 24" class="w-6 h-6" aria-hidden="true">
                        <path
                            fill-rule="evenodd"
                            d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0022 12.017C22 6.484 17.522 2 12 2z"
                            clip-rule="evenodd"
                        />
                    </svg>
                </a>
            </div>
            <p class="mt-10 text-xs leading-5 text-center text-gray-500 dark:text-gray-400">
                &copy; <span id="current-year"></span> Alexandru Nastase. All rights reserved.
            </p>
        </div>
    </footer>

    <!-- Add notification div for copy success -->
    <div id="copy-notification">Copied to clipboard!</div>
    
    <!-- Main JavaScript -->
    <script>
        // Initialize variables
        let editorView;
        
        // Default JSON content
        const defaultValue = {
            "Hint": "JSON goes here",
            "Step 1": "Ctrl + V to paste code (it's selected by default)",
            "Step 2": "Alt + Shift + F to format",
            "Keyboard Shortcuts": {
                "Ctrl + A": "Select all text",
                "Ctrl + X": "Cut current line",
                "Alt + Shift + F": "Format",
                "Alt + Shift + M": "Minify"
            }
        };
        
        // Initialize CodeMirror editor
        document.addEventListener('DOMContentLoaded', function() {
            // Set current year in footer
            document.getElementById('current-year').textContent = new Date().getFullYear();
            
            // Function to initialize editor when CM6 is available
            function initEditor() {
                if (!window.CM6) {
                    // If CM6 is not available yet, try again in 100ms
                    console.log("Waiting for CodeMirror 6 modules to load...");
                    setTimeout(initEditor, 100);
                    return;
                }
                
                const { EditorView, basicSetup, json, linter, lintGutter, jsonParseLinter, keymap, indentWithTab } = window.CM6;
            
            // Create custom theme extension
            const lightTheme = EditorView.theme({
                "&": {
                    backgroundColor: "#ffffff",
                    color: "#000000"
                },
                ".cm-content": {
                    caretColor: "#000000"
                },
                ".cm-cursor": {
                    borderLeftColor: "#000000"
                },
                "&.cm-focused .cm-selectionBackground, .cm-selectionBackground": {
                    backgroundColor: "rgba(100, 100, 255, 0.2)"
                },
                ".cm-activeLine": {
                    backgroundColor: "rgba(0, 0, 0, 0.05)"
                },
                ".cm-gutters": {
                    backgroundColor: "#ffffff",
                    color: "#1b1b1b",
                    border: "none"
                },
                ".cm-gutterElement": {
                    color: "#5c5c5c",
                    fontWeight: "800"
                }
            });
            
            // Create JSON linter
            const jsonLint = linter(view => {
                const doc = view.state.doc;
                const diagnostics = [];
                try {
                    JSON.parse(doc.toString());
                } catch (e) {
                    if (e instanceof SyntaxError) {
                        // Try to extract line and position info from the error message
                        const match = /at position (\d+)/.exec(e.message);
                        if (match) {
                            const pos = parseInt(match[1]);
                            const line = doc.lineAt(Math.min(pos, doc.length));
                            diagnostics.push({
                                from: line.from,
                                to: line.to,
                                severity: "error",
                                message: e.message
                            });
                        } else {
                            // Fallback if we can't parse the position
                            diagnostics.push({
                                from: 0,
                                to: Math.min(100, doc.length),
                                severity: "error",
                                message: e.message
                            });
                        }
                    }
                }
                return diagnostics;
            });
            
                // Create editor with extensions
                editorView = new EditorView({
                    doc: JSON.stringify(defaultValue, null, 2),
                    extensions: [
                        basicSetup,
                        json(),
                        lintGutter(),
                        jsonLint,
                        lightTheme,
                        EditorView.lineWrapping,
                        keymap.of([indentWithTab]),
                        EditorView.updateListener.of(update => {
                            if (update.docChanged) {
                                // Document changed
                            }
                        })
                    ],
                    parent: document.getElementById('editor-container')
                });
                
                // Select all text initially
                setTimeout(() => {
                    const docLength = editorView.state.doc.length;
                    editorView.dispatch({
                        selection: {anchor: 0, head: docLength}
                    });
                    editorView.focus();
                }, 100);
            
                // Theme toggle functionality
                const themeToggle = document.getElementById('theme-toggle');
                themeToggle.addEventListener('click', toggleTheme);
                
                // Format button functionality
                const formatButton = document.getElementById('format-button');
                formatButton.addEventListener('click', formatJSON);
                
                // Minify button functionality
                const minifyButton = document.getElementById('minify-button');
                minifyButton.addEventListener('click', minifyJSON);
                
                // Copy button functionality
                const copyButton = document.getElementById('copy-button');
                copyButton.addEventListener('click', copyToClipboard);
                
                // Add keyboard shortcuts
                document.addEventListener('keydown', handleKeyDown);
            }
            
            // Start the initialization process
            initEditor();
        });
        
        // Toggle theme function
        function toggleTheme() {
            const isDark = document.documentElement.classList.contains('dark');
            
            if (isDark) {
                document.documentElement.classList.remove('dark');
                localStorage.setItem('isDarkMode', 'false');
                // Theme is handled via CSS for CM6
            } else {
                document.documentElement.classList.add('dark');
                localStorage.setItem('isDarkMode', 'true');
                // Theme is handled via CSS for CM6
            }
        }
        
        // Get editor content
        function getEditorContent() {
            return editorView.state.doc.toString();
        }
        
        // Set editor content
        function setEditorContent(content) {
            const transaction = editorView.state.update({
                changes: {
                    from: 0,
                    to: editorView.state.doc.length,
                    insert: content
                }
            });
            editorView.dispatch(transaction);
        }
        
        // Format JSON function
        function formatJSON() {
            try {
                const currentContent = getEditorContent();
                const parsed = JSON.parse(currentContent);
                const formatted = JSON.stringify(parsed, null, 2);
                setEditorContent(formatted);
            } catch (e) {
                alert('Invalid JSON: ' + e.message);
            }
        }
        
        // Minify JSON function
        function minifyJSON() {
            try {
                const currentContent = getEditorContent();
                const parsed = JSON.parse(currentContent);
                const minified = JSON.stringify(parsed);
                setEditorContent(minified);
            } catch (e) {
                alert('Invalid JSON: ' + e.message);
            }
        }
        
        // Copy to clipboard function
        function copyToClipboard() {
            try {
                const currentContent = getEditorContent();
                navigator.clipboard.writeText(currentContent)
                    .then(() => {
                        const copyButton = document.getElementById('copy-button');
                        const originalText = copyButton.innerHTML;
                        copyButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-1"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" /></svg>Copied!';
                        setTimeout(() => {
                            copyButton.innerHTML = originalText;
                        }, 2000);
                    })
                    .catch(err => {
                        console.error('Failed to copy text: ', err);
                        alert('Failed to copy to clipboard');
                    });
            } catch (e) {
                console.error('Copy failed:', e);
                alert('Failed to copy to clipboard');
            }
        }
        
        // Handle keyboard shortcuts
        function handleKeyDown(e) {
            // Alt+Shift+F for format
            if (e.altKey && e.shiftKey && e.key === 'F') {
                e.preventDefault();
                formatJSON();
            }
            // Alt+Shift+M for minify
            if (e.altKey && e.shiftKey && e.key === 'M') {
                e.preventDefault();
                minifyJSON();
            }
        }
    </script>
</body>
</html>
