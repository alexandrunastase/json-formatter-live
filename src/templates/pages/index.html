<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JSON Formatter Live</title>
  <link rel="icon" href="/favicon.ico" type="image/x-icon">
  <link rel="manifest" href="/manifest.json">

  <!-- Tailwind CSS via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
      tailwind.config = {
          darkMode: 'class',
          theme: {
              extend: {
                  colors: {
                      zinc: {
                          50: '#fafafa',
                          100: '#f4f4f5',
                          200: '#e4e4e7',
                          300: '#d4d4d8',
                          400: '#a1a1aa',
                          500: '#71717a',
                          600: '#52525b',
                          700: '#3f3f46',
                          800: '#27272a',
                          900: '#18181b',
                      }
                  }
              }
          }
      }
  </script>

  <!-- CodeMirror 6 bundle -->
  <script type="module" src="/js/codemirror-bundle.js"></script>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">

  <!-- Custom styles -->
  <link rel="stylesheet" href="/styles/style.css">
  <link rel="stylesheet" href="/styles/editor.css">

  <!-- Theme initialization script -->
  <script>
      // Check for saved theme preference or use system preference
      const initializeTheme = () => {
          const isDarkMode = localStorage.getItem('isDarkMode') === 'true' ||
              (localStorage.getItem('isDarkMode') === null &&
                  window.matchMedia('(prefers-color-scheme: dark)').matches);

          if (isDarkMode) {
              document.documentElement.classList.add('dark');
          } else {
              document.documentElement.classList.remove('dark');
          }
      };

      // Initialize theme before page loads to prevent flash
      initializeTheme();
  </script>
</head>

{% include "components/header.html" %}

<body
  class="bg-gray-50 dark:bg-zinc-800 text-gray-900 dark:text-gray-100 transition-colors duration-150 min-h-screen flex flex-col">
<!-- Main content -->
<div
  class="flex min-h-64 flex-col justify-center overflow-hidden bg-gray-50 dark:bg-zinc-800 mt-12 max-w-full transition-colors duration-150">
  <div
    class="h-full border-2 border-gray-200 dark:border-gray-700 bg-white dark:bg-zinc-900 px-6 pt-10 pb-8 shadow-xl ring-1 ring-gray-900/5 dark:ring-gray-100/5 sm:rounded-lg sm:px-10 mx-6 mb-16 editor-container transition-colors duration-150 relative">
    <div class="absolute top-4 right-6 z-10">
      <button
        id="copy-button"
        class="inline-flex items-center px-3 py-2 text-sm font-medium rounded-md text-gray-700 dark:text-gray-300 bg-white dark:bg-zinc-800 border border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-zinc-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 dark:focus:ring-blue-400 dark:focus:ring-offset-zinc-800 transition-colors duration-150"
        title="Copy to clipboard"
      >
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
             stroke="currentColor" class="w-5 h-5 mr-1">
          <path stroke-linecap="round" stroke-linejoin="round"
                d="M15.666 3.888A2.25 2.25 0 0 0 13.5 2.25h-3c-1.03 0-1.9.693-2.166 1.638m7.332 0c.055.194.084.4.084.612v0a.75.75 0 0 1-.75.75H9a.75.75 0 0 1-.75-.75v0c0-.212.03-.418.084-.612m7.332 0c.646.049 1.288.11 1.927.184 1.1.128 1.907 1.077 1.907 2.185V19.5a2.25 2.25 0 0 1-2.25 2.25H6.75A2.25 2.25 0 0 1 4.5 19.5V6.257c0-1.108.806-2.057 1.907-2.185a48.208 48.208 0 0 1 1.927-.184"/>
        </svg>
        Copy
      </button>
    </div>
    <div id="editor-container" class="w-full h-full"></div>
    <div class="absolute bottom-4 right-6">
      <div class="flex justify-end gap-2">
        <button
          id="format-button"
          class="inline-flex items-center px-3 py-2 text-sm font-medium rounded-md text-gray-700 dark:text-gray-300 bg-white dark:bg-zinc-800 border border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-zinc-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 dark:focus:ring-blue-400 dark:focus:ring-offset-zinc-800 transition-colors duration-150"
          title="Format JSON (Alt+Shift+F)"
        >
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
               stroke="currentColor" class="h-5 w-5 mr-1">
            <path stroke-linecap="round" stroke-linejoin="round"
                  d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z"/>
          </svg>
          Format
        </button>
        <button
          id="minify-button"
          class="inline-flex items-center px-3 py-2 text-sm font-medium rounded-md text-gray-700 dark:text-gray-300 bg-white dark:bg-zinc-800 border border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-zinc-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 dark:focus:ring-blue-400 dark:focus:ring-offset-zinc-800 transition-colors duration-150"
          title="Minify JSON (Alt+Shift+M)"
        >
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
               stroke="currentColor" class="h-5 w-5 mr-1">
            <path stroke-linecap="round" stroke-linejoin="round"
                  d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m.75 12l3 3m0 0l3-3m-3 3v-6m-1.5-9H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z"/>
          </svg>
          Minify
        </button>
      </div>
    </div>
  </div>
</div>

{% include "components/footer.html" %}

<!-- Main JavaScript -->
<script>
    // Initialize variables
    let editorView;

    // Default JSON content
    const defaultValue = {
        "Hint": "JSON goes here",
        "Step 1": "Ctrl + V to paste code (it's selected by default)",
        "Step 2": "Alt + Shift + F to format",
        "Keyboard Shortcuts": {
            "Ctrl + A": "Select all text",
            "Ctrl + X": "Cut current line",
            "Alt + Shift + F": "Format",
            "Alt + Shift + M": "Minify"
        }
    };

    // Initialize CodeMirror editor
    document.addEventListener('DOMContentLoaded', function () {

        // Function to initialize editor when CM6 is available
        function initEditor() {
            if (!window.CM6) {
                // If CM6 is not available yet, try again in 100ms
                console.log("Waiting for CodeMirror 6 modules to load...");
                setTimeout(initEditor, 100);
                return;
            }

            const {
                EditorView,
                basicSetup,
                json,
                linter,
                lintGutter,
                jsonParseLinter,
                keymap,
                indentWithTab
            } = window.CM6;
            
            // Create custom theme extension
            const lightTheme = EditorView.theme({
                "&": {
                    backgroundColor: "#ffffff",
                    color: "#000000"
                },
                ".cm-content": {
                    caretColor: "#000000"
                },
                ".cm-cursor": {
                    borderLeftColor: "#000000"
                },
                "&.cm-focused .cm-selectionBackground, .cm-selectionBackground": {
                    backgroundColor: "rgba(100, 100, 255, 0.2)"
                },
                ".cm-activeLine": {
                    backgroundColor: "rgba(0, 0, 0, 0.05)"
                },
                ".cm-gutters": {
                    backgroundColor: "#ffffff",
                    color: "#1b1b1b",
                    border: "none"
                },
                ".cm-gutterElement": {
                    color: "#5c5c5c",
                    fontWeight: "800"
                }
            });
            
            // Create JSON linter
            const jsonLint = linter(view => {
                const doc = view.state.doc;
                const diagnostics = [];
                try {
                    JSON.parse(doc.toString());
                } catch (e) {
                    if (e instanceof SyntaxError) {
                        // Try to extract line and position info from the error message
                        const match = /at position (\d+)/.exec(e.message);
                        if (match) {
                            const pos = parseInt(match[1]);
                            const line = doc.lineAt(Math.min(pos, doc.length));
                            diagnostics.push({
                                from: line.from,
                                to: line.to,
                                severity: "error",
                                message: e.message
                            });
                        } else {
                            // Fallback if we can't parse the position
                            diagnostics.push({
                                from: 0,
                                to: Math.min(100, doc.length),
                                severity: "error",
                                message: e.message
                            });
                        }
                    }
                }
                return diagnostics;
            });
            
            // Create editor with extensions
            editorView = new EditorView({
                doc: JSON.stringify(defaultValue, null, 2),
                extensions: [
                    basicSetup,
                    json(),
                    lintGutter(),
                    jsonLint,
                    lightTheme,
                    EditorView.lineWrapping,
                    keymap.of([indentWithTab]),
                    EditorView.updateListener.of(update => {
                        if (update.docChanged) {
                            // Document changed
                        }
                    })
                ],
                parent: document.getElementById('editor-container')
            });

            // Select all text initially
            setTimeout(() => {
                const docLength = editorView.state.doc.length;
                editorView.dispatch({
                    selection: {anchor: 0, head: docLength}
                });
                editorView.focus();
            }, 100);
            
            // Theme toggle functionality
            const themeToggle = document.getElementById('theme-toggle');
            themeToggle.addEventListener('click', toggleTheme);

            // Format button functionality
            const formatButton = document.getElementById('format-button');
            formatButton.addEventListener('click', formatJSON);

            // Minify button functionality
            const minifyButton = document.getElementById('minify-button');
            minifyButton.addEventListener('click', minifyJSON);

            // Copy button functionality
            const copyButton = document.getElementById('copy-button');
            copyButton.addEventListener('click', copyToClipboard);

            // Add keyboard shortcuts
            document.addEventListener('keydown', handleKeyDown);
        }

        // Start the initialization process
        initEditor();
    });

    // Toggle theme function
    function toggleTheme() {
        const isDark = document.documentElement.classList.contains('dark');

        if (isDark) {
            document.documentElement.classList.remove('dark');
            localStorage.setItem('isDarkMode', 'false');
            // Theme is handled via CSS for CM6
        } else {
            document.documentElement.classList.add('dark');
            localStorage.setItem('isDarkMode', 'true');
            // Theme is handled via CSS for CM6
        }
    }

    // Get editor content
    function getEditorContent() {
        return editorView.state.doc.toString();
    }

    // Set editor content
    function setEditorContent(content) {
        const transaction = editorView.state.update({
            changes: {
                from: 0,
                to: editorView.state.doc.length,
                insert: content
            }
        });
        editorView.dispatch(transaction);
    }

    // Format JSON function
    function formatJSON() {
        try {
            const currentContent = getEditorContent();
            const parsed = JSON.parse(currentContent);
            const formatted = JSON.stringify(parsed, null, 2);
            setEditorContent(formatted);
        } catch (e) {
            alert('Invalid JSON: ' + e.message);
        }
    }

    // Minify JSON function
    function minifyJSON() {
        try {
            const currentContent = getEditorContent();
            const parsed = JSON.parse(currentContent);
            const minified = JSON.stringify(parsed);
            setEditorContent(minified);
        } catch (e) {
            alert('Invalid JSON: ' + e.message);
        }
    }

    // Copy to clipboard function
    function copyToClipboard() {
        try {
            const currentContent = getEditorContent();
            navigator.clipboard.writeText(currentContent)
                .then(() => {
                    const copyButton = document.getElementById('copy-button');
                    const originalText = copyButton.innerHTML;
                    copyButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-1"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" /></svg>Copied!';
                    setTimeout(() => {
                        copyButton.innerHTML = originalText;
                    }, 2000);
                })
                .catch(err => {
                    console.error('Failed to copy text: ', err);
                    alert('Failed to copy to clipboard');
                });
        } catch (e) {
            console.error('Copy failed:', e);
            alert('Failed to copy to clipboard');
        }
    }

    // Handle keyboard shortcuts
    function handleKeyDown(e) {
        // Alt+Shift+F for format
        if (e.altKey && e.shiftKey && e.key === 'F') {
            e.preventDefault();
            formatJSON();
        }
        // Alt+Shift+M for minify
        if (e.altKey && e.shiftKey && e.key === 'M') {
            e.preventDefault();
            minifyJSON();
        }
    }
</script>
</body>
</html>
